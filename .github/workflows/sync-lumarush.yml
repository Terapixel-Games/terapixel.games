name: Sync LumaRush Build

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "LumaRush release tag to sync (for example: v1.2.3)"
        required: false
        default: ""
      release_asset:
        description: "LumaRush release asset name (optional)"
        required: false
        default: ""
  repository_dispatch:
    types: [lumarush_main_updated]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout terapixel.games
        uses: actions/checkout@v4

      - name: Resolve payload values
        id: vars
        shell: bash
        run: |
          SOURCE_REPO="${{ github.event.client_payload.source_repo }}"
          RELEASE_TAG="${{ github.event.client_payload.release_tag }}"
          RELEASE_ASSET="${{ github.event.client_payload.release_asset }}"

          if [ -z "$SOURCE_REPO" ]; then
            SOURCE_REPO="TeraPixelGames/LumaRush"
          fi

          if [ -z "$RELEASE_TAG" ]; then
            RELEASE_TAG="${{ inputs.release_tag }}"
          fi

          if [ -z "$RELEASE_TAG" ]; then
            LATEST_JSON=$(curl -sS \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${SOURCE_REPO}/releases/latest")
            RELEASE_TAG=$(LATEST_JSON="$LATEST_JSON" python -c "import json,os; print(json.loads(os.environ.get('LATEST_JSON','{}')).get('tag_name',''))")
          fi

          if [ -z "$RELEASE_ASSET" ]; then
            RELEASE_ASSET="${{ inputs.release_asset }}"
          fi
          if [ -z "$RELEASE_ASSET" ]; then
            VERSION="${RELEASE_TAG#v}"
            RELEASE_ASSET="lumarush-web-${VERSION}.zip"
          fi

          if [ -z "$RELEASE_TAG" ]; then
            echo "Unable to resolve release tag"
            exit 1
          fi

          echo "source_repo=$SOURCE_REPO" >> "$GITHUB_OUTPUT"
          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "release_asset=$RELEASE_ASSET" >> "$GITHUB_OUTPUT"

      - name: Download and extract LumaRush release asset
        shell: bash
        env:
          READ_TOKEN: ${{ secrets.LUMARUSH_RELEASE_READ_TOKEN }}
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip rsync

          API_URL="https://api.github.com/repos/${{ steps.vars.outputs.source_repo }}/releases/tags/${{ steps.vars.outputs.release_tag }}"
          BROWSER_URL=$(python - "$API_URL" "${{ steps.vars.outputs.release_asset }}" "$READ_TOKEN" <<'PY'
import json
import sys
import urllib.request

api_url = sys.argv[1]
asset_name = sys.argv[2]
token = sys.argv[3] if len(sys.argv) > 3 else ""

headers = {"Accept": "application/vnd.github+json"}
if token:
    headers["Authorization"] = f"Bearer {token}"

req = urllib.request.Request(api_url, headers=headers)
with urllib.request.urlopen(req) as resp:
    data = json.loads(resp.read().decode("utf-8"))

for asset in data.get("assets", []):
    if asset.get("name") == asset_name:
        print(asset.get("browser_download_url", ""))
        break
PY
          )

          if [ -z "$BROWSER_URL" ]; then
            echo "Release asset not found: ${{ steps.vars.outputs.release_asset }}"
            exit 1
          fi

          AUTH_HEADER=()
          if [ -n "${READ_TOKEN:-}" ]; then
            AUTH_HEADER=(-H "Authorization: Bearer ${READ_TOKEN}")
          fi

          curl -sS -L "${AUTH_HEADER[@]}" \
            -o /tmp/lumarush-web.zip \
            "$BROWSER_URL"

          rm -rf /tmp/lumarush-build
          mkdir -p /tmp/lumarush-build
          unzip -o /tmp/lumarush-web.zip -d /tmp/lumarush-build
          test -f /tmp/lumarush-build/build/web/index.html

      - name: Sync LumaRush build into public/play/lumarush
        shell: bash
        run: |
          mkdir -p public/play/lumarush
          rsync -a --delete "/tmp/lumarush-build/build/web/" public/play/lumarush/

      - name: Set LumaRush URLs to same-domain path
        shell: bash
        run: |
          node <<'EOF'
          const fs = require('fs');
          const path = 'src/data/games.json';
          const games = JSON.parse(fs.readFileSync(path, 'utf8'));
          for (const game of games) {
            if (game.slug === 'lumarush') {
              game.fullScreenUrl = '/play/lumarush/';
              game.embedUrl = '/play/lumarush/';
            }
          }
          fs.writeFileSync(path, JSON.stringify(games, null, 2) + '\n');
          EOF

      - name: Commit and push changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add public/play/lumarush src/data/games.json
          git commit -m "sync: update LumaRush web build"
          git push
