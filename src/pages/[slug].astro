---
import BaseLayout from '../layouts/BaseLayout.astro';
import games from '../data/games.json';
import type { Game } from '../types';

export function getStaticPaths() {
  const gameList = games as Game[];
  return gameList.map((game) => ({
    params: { slug: game.slug },
    props: { game, allGames: gameList }
  }));
}

const { game, allGames } = Astro.props as { game: Game; allGames: Game[] };
const mapPlayableUrl = (value: string | null): string | null => {
  if (!value) return null;
  if (value.startsWith('/play/')) {
    return `../play/${value.slice('/play/'.length)}`;
  }
  return value;
};
const embedUrl = mapPlayableUrl(game.embedUrl);
const fullScreenUrl = mapPlayableUrl(game.fullScreenUrl);
const showEmbed = Boolean(embedUrl);
const showFullScreen = Boolean(fullScreenUrl);
const isPortraitEmbed = game.embedOrientation === 'portrait';

const fallbackIntro = `${game.title} is a browser game from Terapixel Games with quick sessions and accessible gameplay.`;
const fallbackDetails =
  'This page includes direct play access, fullscreen support when available, and a focused game hub for players returning to improve their results.';
const fallbackHowToPlay = `Launch ${game.title}, learn the core loop, and improve performance over repeated sessions.`;
const fallbackFeatures = ['Instant browser play', 'Short sessions with replay value', 'Works well on modern desktop and mobile browsers'];

const seoIntro = game.seoIntro ?? fallbackIntro;
const seoDetails = game.seoDetails ?? fallbackDetails;
const seoHowToPlay = game.seoHowToPlay ?? fallbackHowToPlay;
const seoFeatures = game.seoFeatures ?? fallbackFeatures;
const faq = game.faq ?? [];

const metaDescription = `${seoIntro} ${seoDetails}`.slice(0, 158);
const siteBase = Astro.site ?? Astro.url;
const canonicalUrl = new URL(`/${game.slug}`, siteBase).toString();
const imageUrl = new URL(game.image, siteBase).toString();
const relatedGames = allGames.filter((candidate) => candidate.slug !== game.slug).slice(0, 3);

const videoGameJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'VideoGame',
  name: game.title,
  url: canonicalUrl,
  image: imageUrl,
  description: metaDescription,
  gamePlatform: 'Web Browser',
  applicationCategory: 'Game',
  operatingSystem: 'Any',
  publisher: {
    '@type': 'Organization',
    name: 'Terapixel Games'
  },
  isAccessibleForFree: true
};

const faqJsonLd =
  faq.length > 0
    ? {
        '@context': 'https://schema.org',
        '@type': 'FAQPage',
        mainEntity: faq.map((entry) => ({
          '@type': 'Question',
          name: entry.question,
          acceptedAnswer: {
            '@type': 'Answer',
            text: entry.answer
          }
        }))
      }
    : null;
---

<BaseLayout title={game.title} description={metaDescription} image={game.image}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify(videoGameJsonLd)} />
  {faqJsonLd && <script slot="head" type="application/ld+json" set:html={JSON.stringify(faqJsonLd)} />}

  <div class="shell stack">
    <section class="page-head">
      <h1 class="detail-title">{game.title}</h1>
      <p class="page-copy">Play in browser now and switch to fullscreen when available.</p>
    </section>

    <section aria-label={`${game.title} player`}>
      {
        showEmbed ? (
          <div class="player-wrap">
            <div class:list={['player-frame', isPortraitEmbed && 'player-frame-portrait']}>
              <iframe
                src={embedUrl as string}
                title={`${game.title} game`}
                loading="lazy"
                allow="fullscreen"
                allowfullscreen
              />
            </div>
          </div>
        ) : (
          <div class="glass-panel text-panel">
            <h2>Coming Soon</h2>
            <p>This title is in development. Check back on the Games page for release updates.</p>
          </div>
        )
      }

      <div class="detail-actions">
        {
          showFullScreen ? (
            <a href={fullScreenUrl as string} target="_blank" rel="noreferrer noopener" class="btn btn-primary">
              Full Screen
            </a>
          ) : (
            <span class="chip muted">Fullscreen coming soon</span>
          )
        }
        <a href="/games" class="btn btn-secondary">Back to Games</a>
      </div>
    </section>

    <section class="content-grid" aria-label="Game details">
      <article class="glass-panel text-panel">
        <h2>About {game.title}</h2>
        <p>{seoIntro}</p>
        <p>{seoDetails}</p>
      </article>

      <article class="glass-panel text-panel">
        <h2>How To Play</h2>
        <p>{seoHowToPlay}</p>
        <ul class="product-list">
          {seoFeatures.map((feature) => <li>{feature}</li>)}
        </ul>
      </article>
    </section>

    {
      faq.length > 0 && (
        <section aria-labelledby="faq-heading" class="stack">
          <h2 id="faq-heading" class="section-title">
            {game.title} FAQ
          </h2>
          <div class="faq-list">
            {faq.map((entry) => (
              <article class="glass-panel faq-item">
                <h3>{entry.question}</h3>
                <p>{entry.answer}</p>
              </article>
            ))}
          </div>
        </section>
      )
    }

    {
      relatedGames.length > 0 && (
        <section aria-labelledby="related-games-heading" class="stack">
          <h2 id="related-games-heading" class="section-title">
            Related Games
          </h2>
          <div class="related-grid">
            {relatedGames.map((relatedGame) => (
              <a href={`/${relatedGame.slug}`} class="related-link">
                <strong>{relatedGame.title}</strong>
                <span>View details</span>
              </a>
            ))}
          </div>
        </section>
      )
    }
  </div>
</BaseLayout>
